<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Level 2 - Versleep de pijlen</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; padding: 30px; background: #f7f9fc; }
h1 { color: #2c3e50; margin-bottom: 25px; max-width: 500px; margin-left:auto; margin-right:auto; font-size: 20px; }
#LVL102exercise { margin-bottom: 25px; font-size: 20px; }
#LVL102choices { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
.arrow { width: 120px; height: 20px; position: relative; cursor: grab; }
.arrow .line { height: 2px; position: absolute; top: 9px; }
.arrow .tip { width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; position: absolute; top: 7px; }
.arrow .dot { width: 8px; height: 8px; background: black; border-radius: 50%; position: absolute; top: 6px; }
#LVL102target { width: 360px; height: 120px; margin: 0 auto 20px auto; position: relative; }
#LVL102target .axis { position: absolute; top: 80px; left: 0; width: 100%; height: 2px; background: black; }
#LVL102target .zero-line { position: absolute; top: 70px; width: 2px; left: 50%; transform: translateX(-50%); height: 20px; background: black; }
#LVL102target .zero { position: absolute; top: 95px; left: 50%; transform: translateX(-50%); font-weight: bold; }
#LVL102target .target-dot { width: 8px; height: 8px; background: black; border-radius: 50%; position: absolute; }
button { padding: 12px 25px; margin-top: 10px; cursor: pointer; border-radius: 12px; border: none; background-color: #007BFF; color: #fff; font-size: 16px; box-shadow: 0 3px 6px rgba(0,0,0,0.2); transition: 0.2s; }
button:hover:enabled { background-color: #0056b3; transform: translateY(-1px); }
button:disabled { opacity: 0.5; cursor: default; }
#LVL102nextBtn { background-color: #28a745; }
#LVL102nextBtn:hover:enabled { background-color: #1e7e34; }
#LVL102feedback { display: none; font-weight: bold; margin-top: 10px; text-align: left; max-width: 500px; margin-left:auto; margin-right:auto; background-color: #fff9e6; padding: 12px 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
#LVL102progressContainer { width: 80%; height: 18px; background: #e6e6e6; border-radius: 10px; margin: 20px auto 30px auto; overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); }
#LVL102progressBar { height: 100%; width: 0%; background: linear-gradient(90deg, #6ddf4b, #4cc936); transition: width 0.4s ease; }
</style>
</head>
<body>

<h1>Level 2 - Versleep de pijlen en maak de pijlenvoorstelling</h1>
<div id="LVL102exercise"></div>
<div id="LVL102choices"></div>

<button id="LVL102resetBtn" disabled>Reset pijlen</button>
<button id="LVL102checkBtn" disabled>Controleer</button>
<div id="LVL102feedback"></div>
<button id="LVL102nextBtn" style="display:none;">Volgende oefening</button>

<div id="LVL102target"></div>

<div id="LVL102progressContainer">
  <div id="LVL102progressBar"></div>
</div>

<script>
const numExercises = 10;
let currentIndex = 0;
let exercises = [];
let xp = 0;

const axisLength = 360;
const longArrowLength = axisLength / 4;
const shortArrowLength = axisLength / 8;

function updateProgressBar(){
  const perc = (currentIndex / numExercises) * 100;
  document.getElementById('LVL102progressBar').style.width = perc + "%";
}

function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function generateUniqueExercises(num){
  const set = new Set();
  const list = [];
  while(list.length < num){
    const form = Math.floor(Math.random()*6);
    let a,b,op;
    switch(form){
      case 0: a=rand(1,10); b=rand(1,10); op='+'; break;
      case 1: a=rand(1,10); b=rand(1,a-1); op='-'; break;
      case 2: a=rand(1,10); b=rand(a+1,15); op='-'; break;
      case 3: a=-rand(1,10); b=rand(1,8); op='+'; break;
      case 4: a=-rand(1,5); b=rand(6,10); op='+'; break;
      case 5: a=-rand(1,10); b=rand(1,8); op='-'; break;
    }
    if(a===b || a===-b) continue;
    const key = `${a}${op}${b}`;
    if(!set.has(key)){
      set.add(key);
      list.push({a,b,op});
    }
  }
  return list;
}

exercises = generateUniqueExercises(numExercises);
let selectedArrows = [];
let extraDot = null;

function showExercise(){
  updateProgressBar();
  if(currentIndex >= exercises.length){
    document.getElementById('LVL102choices').innerHTML='';
    document.getElementById('LVL102exercise').innerHTML='';
    document.getElementById('LVL102resetBtn').style.display='none';
    document.getElementById('LVL102checkBtn').style.display='none';
    document.getElementById('LVL102nextBtn').style.display='none';
    let geslaagd = xp >= 12;
    const fb = document.getElementById('LVL102feedback');
    fb.style.display='none';
    let msg = geslaagd ? `üéâ Goed zo! Je hebt dit onder de knie!` : `Dit lukt nog niet zo goed.<br>Je hebt extra stappen nodig om dit doel te bereiken.`;
    document.getElementById('LVL102target').innerHTML='';
    document.getElementById('LVL102exercise').innerHTML=`
      <div style="background:white; padding:25px; border-radius:20px; 
                  box-shadow:0 4px 12px rgba(0,0,0,0.15); max-width:350px; margin: auto;">
         <h2 style="color:#2c3e50;">üéâ Level voltooid! üéâ</h2>
         <div style="font-size:40px; margin:15px 0; color:#f4a300;">‚≠ê ${xp} XP</div>
         <div style="font-size:18px; margin-top:10px;">${msg}</div>
         <button id="LVL102backBtn" style="margin-top:15px;">Terug naar kaart</button>
      </div>
    `;
    document.getElementById('LVL102backBtn').onclick = ()=>{ if(window.parent.completeLevelFromIframe){ window.parent.completeLevelFromIframe(xp, geslaagd); } };
    return;
  }

  const ex = exercises[currentIndex];
  selectedArrows = [];
  extraDot = null;
  document.getElementById('LVL102exercise').innerHTML=`<h2>${ex.a} ${ex.op} ${ex.b}</h2>`;
  document.getElementById('LVL102feedback').style.display='none';

  const choicesDiv = document.getElementById('LVL102choices');
  choicesDiv.innerHTML='';
  const resetBtn = document.getElementById('LVL102resetBtn');
  const checkBtn = document.getElementById('LVL102checkBtn');
  resetBtn.disabled = true;
  checkBtn.disabled = true;
  resetBtn.style.display='inline-block';
  checkBtn.style.display='inline-block';
  document.getElementById('LVL102nextBtn').style.display='none';

  const arrowData = [
    {color:'blue',dir:'right',len:longArrowLength,idx:0},
    {color:'blue',dir:'right',len:shortArrowLength,idx:1},
    {color:'orange',dir:'left',len:longArrowLength,idx:2},
    {color:'orange',dir:'left',len:shortArrowLength,idx:3}
  ];

  const targetDiv = document.getElementById('LVL102target');
  targetDiv.innerHTML='<div class="axis"></div>';

  const zeroLine = document.createElement('div');
  zeroLine.className='zero-line';
  targetDiv.appendChild(zeroLine);

  const zeroLabel = document.createElement('div');
  zeroLabel.className='zero';
  zeroLabel.innerText='0';
  targetDiv.appendChild(zeroLabel);

  const firstDot = document.createElement('div');
  firstDot.className='target-dot';
  firstDot.style.left='50%';
  firstDot.style.transform='translateX(-50%)';
  firstDot.style.top='50px';
  firstDot.dataset.idx='0';
  targetDiv.appendChild(firstDot);

  arrowData.forEach(a=>{
    const div = document.createElement('div');
    div.className='arrow';
    div.style.width=a.len+'px';

    const line = document.createElement('div');
    line.className='line';
    line.style.background=a.color;
    line.style.width=a.len+'px';
    line.style.left='0';
    div.appendChild(line);

    const tip = document.createElement('div');
    tip.className='tip';
    tip.style.borderTopColor='transparent';
    tip.style.borderBottomColor='transparent';
    tip.style.top='5px';
    if(a.dir==='right'){ tip.style.borderLeft=`10px solid ${a.color}`; tip.style.left=(a.len-10)+'px'; }
    else { tip.style.borderRight=`10px solid ${a.color}`; tip.style.left='0px'; }
    div.appendChild(tip);

    const dot = document.createElement('div');
    dot.className='dot';
    dot.style.left = a.dir==='right' ? '0px' : (a.len-8)+'px';
    div.appendChild(dot);

    div.dataset.idx=a.idx;
    div.dataset.color=a.color;
    div.dataset.dir=a.dir;
    div.dataset.len=a.len;

    div.dataset.originalParent='LVL102choices';
    div.dataset.originalLeft='';
    div.dataset.originalTop='';

    div.onmousedown = dragMouseDown;
    choicesDiv.appendChild(div);
  });

  function dragMouseDown(e){
    if(this.classList.contains('fixed')) return;
    e.preventDefault();
    let elm = this;

    const shiftX = e.clientX - elm.getBoundingClientRect().left;
    const shiftY = e.clientY - elm.getBoundingClientRect().top;

    const placeholder = document.createElement('div');
    placeholder.className='placeholder';
    placeholder.style.width = elm.offsetWidth + 'px';
    placeholder.style.height = elm.offsetHeight + 'px';
    const parent = elm.parentNode;
    parent.insertBefore(placeholder, elm);
    elm.style.position='absolute';
    elm.style.zIndex=1000;

    function moveAt(pageX,pageY){ 
      elm.style.left = pageX-shiftX+'px'; 
      elm.style.top = pageY-shiftY+'px'; 
    }
    function onMouseMove(event){ moveAt(event.pageX,event.pageY); }

    document.addEventListener('mousemove',onMouseMove);

    elm.onmouseup = function(){
      document.removeEventListener('mousemove',onMouseMove);
      elm.onmouseup=null;

      const startDot = extraDot ? extraDot : firstDot;
      const dot = elm.querySelector('.dot');
      const dotRect = dot.getBoundingClientRect();
      const targetRect = startDot.getBoundingClientRect();

      if(Math.abs(dotRect.left-targetRect.left)<15 && Math.abs(dotRect.top-targetRect.top)<15){
        elm.style.display='none';

        const arrowLen = parseFloat(elm.dataset.len);
        const dir = elm.dataset.dir;
        const color = elm.dataset.color;

        const startX = startDot.offsetLeft + startDot.offsetWidth/2;
        const startY = startDot.offsetTop + startDot.offsetHeight/2;
        const endX = dir==='right' ? startX+arrowLen : startX-arrowLen;

        const newArrow = document.createElement('div');
        newArrow.className='arrow';
        newArrow.style.position='absolute';
        newArrow.style.left = Math.min(startX,endX)+'px';
        newArrow.style.top = startY-9+'px';

        if(!selectedArrows.find(a=>a.dataset.term==='a')){
            newArrow.dataset.value = Math.abs(ex.a);
            newArrow.dataset.term = 'a';
        } else {
            newArrow.dataset.value = Math.abs(ex.b);
            newArrow.dataset.term = 'b';
        }
        newArrow.dataset.dir = dir;

        const line = document.createElement('div');
        line.className='line';
        line.style.background=color;
        line.style.position='absolute';
        line.style.left='0px';
        line.style.top='9px';
        line.style.width = Math.abs(endX-startX)+'px';
        newArrow.appendChild(line);

        const tip = document.createElement('div');
        tip.className='tip';
        tip.style.borderTopColor='transparent';
        tip.style.borderBottomColor='transparent';
        tip.style.top='5px';
        if(dir==='right'){ tip.style.borderLeft=`10px solid ${color}`; tip.style.left=(Math.abs(endX-startX)-10)+'px'; }
        else { tip.style.borderRight=`10px solid ${color}`; tip.style.left='0px'; }
        newArrow.appendChild(tip);

        targetDiv.appendChild(newArrow);
        selectedArrows.push(newArrow);

        if(!extraDot){
          extraDot = document.createElement('div');
          extraDot.className='target-dot';
          const offsetX = dir==='right' ? arrowLen : -arrowLen;
          extraDot.style.left = (firstDot.offsetLeft + offsetX) + 'px';
          extraDot.style.top = (firstDot.offsetTop - 30) + 'px';
          targetDiv.appendChild(extraDot);
        }

        resetBtn.disabled=false;

        checkBtn.disabled = selectedArrows.length!==2;

        if(selectedArrows.length===2){
          const remainingArrows = document.querySelectorAll('#LVL102choices .arrow');
          remainingArrows.forEach(a=>{
            a.classList.add('fixed');
            a.style.cursor='default';
          });
        }

      } else {
        parent.insertBefore(elm, placeholder);
        elm.style.position='';
        elm.style.left='';
        elm.style.top='';
      }
      placeholder.remove();
    };
  }
}

// --- reset functionaliteit ---
document.getElementById('LVL102resetBtn').onclick = ()=>{
  selectedArrows.forEach(a=>a.remove());
  selectedArrows=[];
  if(extraDot){ extraDot.remove(); extraDot=null; }

  const choices = document.querySelectorAll('#LVL102choices .arrow');
  choices.forEach(c=>{
    c.style.display='block';
    c.style.position='';
    c.style.left='';
    c.style.top='';
    c.classList.remove('fixed');
  });

  document.querySelectorAll('#LVL102choices .placeholder').forEach(p=>p.remove());

  document.getElementById('LVL102resetBtn').disabled=true;
  document.getElementById('LVL102checkBtn').disabled=true;
};

// --- check knop met XP toekenning ---
document.getElementById('LVL102checkBtn').onclick = ()=>{
  const ex = exercises[currentIndex];
  let feedbackMessages = [];
  let lengthFeedback = '';
  let correctAnswer = false; // volledig correct?

  if(selectedArrows.length === 2){
    const arrowA = selectedArrows.find(a=>a.dataset.term==='a');
    const arrowB = selectedArrows.find(a=>a.dataset.term==='b');

    const dirACorrect = (ex.a >= 0 && arrowA.dataset.dir==='right') || (ex.a < 0 && arrowA.dataset.dir==='left');
    const dirBCorrect = ((ex.op==='+' && arrowB.dataset.dir==='right') || (ex.op==='-' && arrowB.dataset.dir==='left'));

    if(!dirACorrect){
      if(arrowA.dataset.dir==='right'){
        feedbackMessages.push(`Bij jou gaat de eerste (onderste) pijl naar rechts. Maar het eerste getal is negatief, dus moet de eerste pijl naar links gaan.`);
      } else {
        feedbackMessages.push(`Bij jou gaat de eerste (onderste) pijl naar links. Maar het eerste getal is positief, dus moet de eerste pijl naar rechts gaan.`);
      }
    }

    if(!dirBCorrect){
      if(arrowB.dataset.dir==='right'){
        feedbackMessages.push(`Bij jou gaat de tweede (bovenste) pijl naar rechts. Maar je trekt een positief getal af, dus de tweede pijl moet naar links gaan.`);
      } else {
        feedbackMessages.push(`Bij jou gaat de tweede (bovenste) pijl naar links. Maar je telt een positief getal op, dus de tweede pijl moet naar rechts gaan.`);
      }
    }

    if(dirACorrect && dirBCorrect){
      const lenA = arrowA.querySelector('.line').offsetWidth;
      const lenB = arrowB.querySelector('.line').offsetWidth;
      const absA = Math.abs(ex.a);
      const absB = Math.abs(ex.b);

      if(absA > absB && lenA <= lenB){
        lengthFeedback = `Je pijlen gaan al de goede kant op. Maar het eerste getal heeft de grootste absolute waarde. De eerste (onderste) pijl moet dus langer zijn dan de tweede pijl.`;
      } else if(absA < absB && lenA >= lenB){
        lengthFeedback = `Je pijlen gaan al de goede kant op. Maar het tweede getal heeft de grootste absolute waarde. De tweede (bovenste) pijl moet dus langer zijn dan de eerste pijl.`;
      } else {
        correctAnswer = true; // volledig correct
      }
    }

  } else {
    feedbackMessages.push('‚ùå Je moet 2 pijlen plaatsen');
  }

  const fb = document.getElementById('LVL102feedback');
  fb.style.display='block';
  fb.innerHTML = feedbackMessages.length>0 ? feedbackMessages.join('<br>') : lengthFeedback || '‚úÖ Goed gedaan!';

  if(correctAnswer){
    const xpGained = currentIndex < 5 ? 1 : 2;
    xp += xpGained;
  }

  document.getElementById('LVL102resetBtn').style.display='none';
  document.getElementById('LVL102checkBtn').style.display='none';
  document.getElementById('LVL102nextBtn').style.display='inline-block';
};

// --- next button --- 
document.getElementById('LVL102nextBtn').onclick = ()=>{
  currentIndex++;
  showExercise();
};

showExercise();
</script>
</body>
</html>

