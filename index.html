<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Wereldkaart Prototype Verticaal</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f4f8; display: flex; justify-content: center; }
#mapContainer { position: relative; width: 400px; min-height: 3000px; margin: 0 auto; }
.lesson-divider { position: absolute; height: 4px; background: #999; width: 100%; }
.level { position: absolute; width: 50px; height: 50px; border-radius: 50%; border: 3px solid #ccc; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; font-size: 12px; font-weight: bold; }
.level:hover { transform: scale(1.1); }
.level.completed-first::after { content: '‚≠ê'; position: absolute; font-size: 18px; }
.level.completed-first { background: gold; border-color: #f4a300; }
.level.completed-retry::after { content: 'üèÖ'; position: absolute; font-size: 18px; }
.level.completed-retry { background: #4a90e2; border-color: #2e5f8a; color: white; }
.level.current { background: #4CAF50; border-color: #2e7d32; }
.level.failed { background: #f8c8d0; border-color: #f08090; }
.level.skipped { background: #e0e0e0; border-color: #999; }
.level.skipped::after { content: '‚ùå'; font-size: 20px; }
.level.locked { background: #e0e0e0; border-color: #999; }
.level.locked::after { content: 'üîí'; font-size: 20px; }
.route-label { position: absolute; width: 120px; height: 45px; border-radius: 25px; background: #d8c7ff; display: flex; justify-content: center; align-items: center; font-weight: bold; left: 50%; transform: translateX(-50%); }
.lesson-title { position: absolute; width: 100%; text-align: center; font-weight: bold; font-size: 14px; left: 0; transform: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#resetBtn { position: fixed; top: 20px; right: 20px; padding: 10px 15px; background: #007BFF; color: white; border: none; border-radius: 10px; cursor: pointer; z-index: 1001; }
#logoutBtn { position: fixed; top: 60px; right: 20px; padding: 10px 15px; background: #dc3545; color: white; border: none; border-radius: 10px; cursor: pointer; z-index: 1001; }
#adminBtn { position: fixed; top: 100px; right: 20px; padding: 10px 15px; background: #6c757d; color: white; border: none; border-radius: 10px; cursor: pointer; z-index: 1001; }
#xpDisplay { position: fixed; top: 20px; left: 20px; padding: 8px 12px; background: #ffd700; color: black; font-weight: bold; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1000; }
#mapPath { position: absolute; top: 0; left: 0; z-index: 0; }
#levelContainer { position: fixed; top:0; left:0; width:100vw; height:100vh; background:white; z-index:2000; display:none; padding:30px; overflow:auto; }
#messageBox { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #d4edda; color: #155724; padding: 15px 25px; border-radius: 12px; font-weight: bold; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: none; z-index: 1500; }
#adminPanel { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; z-index: 3000; display: none; padding: 30px; overflow: auto; }
#adminPanel h1 { margin-bottom: 20px; }
#adminPanel select { padding: 8px; font-size: 16px; margin-bottom: 20px; width: 300px; }
#adminPanel .lesson-section { margin-bottom: 30px; }
#adminPanel .lesson-section h3 { margin-bottom: 10px; }
#adminPanel .progress-bar { display: flex; gap: 5px; flex-wrap: wrap; }
#adminPanel .level-box { width: 60px; height: 60px; border: 2px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; text-align: center; padding: 5px; box-sizing: border-box; position: relative; }
#adminPanel .level-box::after { position: absolute; top: 2px; right: 2px; font-size: 14px; }
#adminPanel .level-box.gold { background: gold; border-color: #f4a300; }
#adminPanel .level-box.gold::after { content: '‚≠ê'; }
#adminPanel .level-box.blue { background: #4a90e2; border-color: #2e5f8a; color: white; }
#adminPanel .level-box.blue::after { content: 'üèÖ'; }
#adminPanel .level-box.green { background: #4CAF50; border-color: #2e7d32; color: white; }
#adminPanel .level-box.red { background: #f8c8d0; border-color: #f08090; }
#adminPanel .level-box.skipped { background: #e0e0e0; border-color: #999; }
#adminPanel .level-box.skipped::after { content: '‚ùå'; }
#adminPanel .level-box.gray { background: #e0e0e0; border-color: #999; }
#adminPanel .level-box.gray::after { content: 'üîí'; }
#adminPanel .close-btn { padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 20px; }
input { margin:5px; padding:5px; width:80px; }
button { padding:5px 10px; margin-top:10px; }
</style>
</head>
<body>

<div id="loginContainer" style="text-align:center; margin-bottom:20px;">
  <label>Naam: <input type="text" id="loginName"></label>
  <button id="loginBtn">Start</button>
</div>
<div id="xpDisplay">XP: 0</div>
<button id="resetBtn">Reset</button>
<button id="logoutBtn">Uitloggen</button>
<button id="adminBtn">Admin üëÅÔ∏è</button>
<div id="mapContainer"></div>
<div id="levelContainer"></div>
<div id="messageBox"></div>

<div id="adminPanel">
  <button class="close-btn" onclick="document.getElementById('adminPanel').style.display='none'; document.getElementById('studentSelect').value=''; document.getElementById('progressView').innerHTML='';">Sluiten</button>
  <h1>üìä Leerlingen Overzicht</h1>
  
  <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
    <h2>‚ûï Nieuwe Leerling Toevoegen</h2>
    <input type="text" id="newStudentName" placeholder="Naam van leerling" style="width: 250px; padding: 8px; margin-right: 10px;">
    <button id="addStudentBtn" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Toevoegen</button>
    <p style="margin-top: 10px; font-size: 14px; color: #666;">De leerling wordt automatisch toegevoegd met actief=true en alle levels leeg.</p>
  </div>
  
  <select id="studentSelect">
    <option value="">-- Selecteer een leerling --</option>
  </select>
  <div id="progressView"></div>
</div>

<script type="module">

document.getElementById('mapContainer').style.display = 'none';
document.getElementById('xpDisplay').style.display = 'none';
document.getElementById('resetBtn').style.display = 'none';
document.getElementById('logoutBtn').style.display = 'none';
document.getElementById('adminBtn').style.display = 'none';

const LESSONS = [
  {id:"les1", levels:[{id:"1-1"},{id:"1-2"},{id:"1-3"},{id:"1-4"},{id:"1-5"},{id:"1-6"},{id:"1-7"},{id:"1-8"},{id:"1-9"},{id:"1-10"},{id:"1-11"},{id:"1-12"}]},
  {id:"les2", levels:[{id:"2-1"},{id:"2-2"},{id:"2-3"},{id:"2-4"}]},
  {id:"les3", levels:[{id:"3-1"},{id:"3-2"},{id:"3-3"},{id:"3-4"}]},
  {id:"les4", levels:[{id:"4-1"},{id:"4-2"},{id:"4-3"},{id:"4-4"},{id:"4-5"},{id:"4-6"},{id:"4-7"},{id:"4-8"}]},
  {id:"les5", levels:[{id:"5-1"},{id:"5-2"},{id:"5-3"},{id:"5-4"}]},
  {id:"les6", levels:[{id:"6-1"},{id:"6-2"},{id:"6-3"}]}
];

const LESSON_NAMES = [
  "1 | Een positief getal optellen en aftrekken",
  "2 | Een negatief getal optellen en aftrekken",
  "3 | Vermenigvuldigen en delen met negatieve getallen",
  "4 | Macht van een getal",
  "5 | Vierkantswortel van een getal",
  "6 | De volgorde van de bewerkingen"
];

let state = JSON.parse(localStorage.getItem('mapState')) || {};
state.xp = state.xp || 0;

// --- Firebase setup ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDIxC6htGU-SNrgYMiXSmIyBm1wHX-ObWk",
  authDomain: "remediering-map.firebaseapp.com",
  databaseURL: "https://remediering-map-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "remediering-map",
  storageBucket: "remediering-map.appspot.com",
  messagingSenderId: "1070819853672",
  appId: "1:1070819853672:web:b4cdefa00ae068826382dd"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

console.log("üî• Firebase verbonden");

// --- Functies ---
function createLeerlingId(naam){ return "leerling_" + naam.toLowerCase().replace(/\s/g,"_"); }
let leerlingIdGlobal; 

function syncLevelsWithDefinition(existingLevels) {
  const allLevelIds = LESSONS.flatMap(l => l.levels.map(lvl => lvl.id));
  const synced = {};
  
  allLevelIds.forEach(id => {
    synced[id] = existingLevels[id] || { attempts: 0 };
  });
  
  return synced;
}

async function saveToFirebase() {
  if(!leerlingIdGlobal) return;
  
  const leerlingRef = ref(db, "leerlingen/" + leerlingIdGlobal);
  
  try {
    const snapshot = await get(leerlingRef);
    const bestaandeData = snapshot.exists() ? snapshot.val() : {};
    
    const syncedLevels = syncLevelsWithDefinition(state);
    
    await set(leerlingRef, {
      ...bestaandeData,
      xp: state.xp,
      levels: syncedLevels,
      laatstBijgewerkt: Date.now()
    });
    
    console.log("üíæ Resultaten opgeslagen in Firebase");
  } catch(err) {
    console.error("‚ùå Fout bij opslaan:", err);
  }
}

function saveState(){ localStorage.setItem('mapState', JSON.stringify(state)); }
function updateXPDisplay(){ document.getElementById('xpDisplay').innerText = `XP: ${state.xp}`; }

async function loadLeerling(naam) {
  const leerlingId = createLeerlingId(naam);
  leerlingIdGlobal = leerlingId;
  const leerlingRef = ref(db, "leerlingen/" + leerlingId);

  try {
    const snapshot = await get(leerlingRef);

    if(!snapshot.exists()){
      alert("Je bent niet geregistreerd. Neem contact op met je leerkracht.");
      return false;
    }

    const data = snapshot.val();
    
    if(data.actief !== true){
      alert("Je account is niet actief.");
      return false;
    }
    
    const existingLevels = data.levels || {};
    state = syncLevelsWithDefinition(existingLevels);
    state.xp = data.xp || 0;
    
    Object.keys(state).forEach(k => { 
      if(k !== "xp" && state[k]) state[k].current = false; 
    });

    let firstFailed = null;
    outerLoop:
    for(let lesson of LESSONS){
      for(let lvl of lesson.levels){
        if(state[lvl.id]?.failed){
          firstFailed = lvl.id;
          break outerLoop;
        }
      }
    }
    if(firstFailed) state[firstFailed].current = true;
    else {
      outerLoop:
      for(let lesson of LESSONS){
        for(let lvl of lesson.levels){
          if(!state[lvl.id]?.completed){
            state[lvl.id] = state[lvl.id] || { attempts: 0 };
            state[lvl.id].current = true;
            break outerLoop;
          }
        }
      }
    }

    console.log(`üîπ Voortgang geladen voor ${naam}`);
    
    localStorage.setItem('loggedInUser', naam);

    document.getElementById('loginContainer').style.display='none';
    document.getElementById('mapContainer').style.display='block';
    document.getElementById('xpDisplay').style.display='block';
    document.getElementById('resetBtn').style.display='block';
    document.getElementById('logoutBtn').style.display='block';
    document.getElementById('adminBtn').style.display='block';

    drawMap();
    await saveToFirebase();
    
    return true;
  } catch(err){
    console.error("‚ùå Fout bij ophalen van Firebase:", err);
    alert("Er is iets misgelopen bij het laden van je voortgang.");
    return false;
  }
}

document.getElementById('loginBtn').onclick = async function() {
  const naam = document.getElementById('loginName').value.trim();
  if(!naam){ alert("Gelieve een naam in te vullen"); return; }
  await loadLeerling(naam);
};

document.getElementById('logoutBtn').onclick = function() {
  localStorage.removeItem('loggedInUser');
  localStorage.removeItem('mapState');
  location.reload();
};

window.addEventListener('DOMContentLoaded', async () => {
  const savedUser = localStorage.getItem('loggedInUser');
  if(savedUser) {
    console.log(`üîÑ Automatisch inloggen als ${savedUser}`);
    await loadLeerling(savedUser);
  }
});

// --- Admin Panel ---
document.getElementById('adminBtn').onclick = async function() {
  const code = prompt("Admin code:");
  if(code !== '852874179639') {
    alert("Verkeerde code");
    return;
  }
  
  // Laad alle leerlingen
  const leerlingenRef = ref(db, "leerlingen");
  try {
    const snapshot = await get(leerlingenRef);
    if(!snapshot.exists()) {
      alert("Geen leerlingen gevonden");
      return;
    }
    
    const leerlingen = snapshot.val();
    const select = document.getElementById('studentSelect');
    select.innerHTML = '<option value="">-- Selecteer een leerling --</option>';
    
    Object.keys(leerlingen).forEach(id => {
      const leerling = leerlingen[id];
      const option = document.createElement('option');
      option.value = id;
      option.textContent = leerling.naam || id;
      select.appendChild(option);
    });
    
    document.getElementById('adminPanel').style.display = 'block';
    
  } catch(err) {
    console.error("Fout bij laden leerlingen:", err);
    alert("Fout bij laden van leerlingen");
  }
};

document.getElementById('studentSelect').onchange = async function() {
  const studentId = this.value;
  if(!studentId) {
    document.getElementById('progressView').innerHTML = '';
    return;
  }
  
  const studentRef = ref(db, "leerlingen/" + studentId);
  try {
    const snapshot = await get(studentRef);
    if(!snapshot.exists()) return;
    
    const studentData = snapshot.val();
    const levels = studentData.levels || {};
    
    // Find current level
    let currentLevelId = null;
    outerLoop:
    for(let lesson of LESSONS) {
      for(let lvl of lesson.levels) {
        if(levels[lvl.id]?.current) {
          currentLevelId = lvl.id;
          break outerLoop;
        }
      }
    }
    
    let html = `<h2>${studentData.naam}</h2>`;
    html += `<p><strong>XP:</strong> ${studentData.xp || 0}</p>`;
    
    LESSONS.forEach((lesson, lIdx) => {
      html += `<div class="lesson-section">`;
      html += `<h3>${LESSON_NAMES[lIdx]}</h3>`;
      html += `<div class="progress-bar">`;
      
      lesson.levels.forEach(lvl => {
        const levelData = levels[lvl.id] || { attempts: 0 };
        const attempts = levelData.attempts || 0;
        
        let colorClass = 'gray';
        
        // Check if this level is before current and has no attempts
        const isBeforeCurrent = currentLevelId && isLevelBefore(lvl.id, currentLevelId);
        
        if(levelData.current) {
          colorClass = 'green';
        } else if(isBeforeCurrent && attempts === 0) {
          colorClass = 'skipped';
        } else if(levelData.completed) {
          colorClass = attempts === 1 ? 'gold' : 'blue';
        } else if(levelData.failed) {
          colorClass = 'red';
        }
        
        html += `<div class="level-box ${colorClass}">`;
        html += `${lvl.id}<br>${attempts}√ó`;
        html += `</div>`;
      });
      
      html += `</div></div>`;
    });
    
    document.getElementById('progressView').innerHTML = html;
    
  } catch(err) {
    console.error("Fout bij laden student:", err);
  }
};

// Helper function to check if level A is before level B
function isLevelBefore(levelA, levelB) {
  let indexA = -1, indexB = -1;
  let currentIndex = 0;
  
  for(let lesson of LESSONS) {
    for(let lvl of lesson.levels) {
      if(lvl.id === levelA) indexA = currentIndex;
      if(lvl.id === levelB) indexB = currentIndex;
      currentIndex++;
    }
  }
  
  return indexA < indexB && indexA !== -1 && indexB !== -1;
}

// Add student functionality
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    const addBtn = document.getElementById('addStudentBtn');
    if(addBtn) {
      addBtn.onclick = async function() {
        const naam = document.getElementById('newStudentName').value.trim();
        if(!naam) {
          alert("Gelieve een naam in te vullen");
          return;
        }
        
        const leerlingId = createLeerlingId(naam);
        const leerlingRef = ref(db, "leerlingen/" + leerlingId);
        
        try {
          // Check if student already exists
          const snapshot = await get(leerlingRef);
          if(snapshot.exists()) {
            alert("Deze leerling bestaat al!");
            return;
          }
          
          // Create new student with all levels initialized
          const allLevels = {};
          LESSONS.forEach(lesson => {
            lesson.levels.forEach(lvl => {
              allLevels[lvl.id] = { attempts: 0 };
            });
          });
          
          // Set first level as current
          allLevels[LESSONS[0].levels[0].id].current = true;
          
          await set(leerlingRef, {
            naam: naam,
            actief: true,
            xp: 0,
            levels: allLevels,
            laatstBijgewerkt: Date.now()
          });
          
          alert(`Leerling "${naam}" succesvol toegevoegd!`);
          document.getElementById('newStudentName').value = '';
          
          // Refresh student list
          const leerlingenRef = ref(db, "leerlingen");
          const allSnapshot = await get(leerlingenRef);
          if(allSnapshot.exists()) {
            const leerlingen = allSnapshot.val();
            const select = document.getElementById('studentSelect');
            select.innerHTML = '<option value="">-- Selecteer een leerling --</option>';
            
            Object.keys(leerlingen).forEach(id => {
              const leerling = leerlingen[id];
              const option = document.createElement('option');
              option.value = id;
              option.textContent = leerling.naam || id;
              select.appendChild(option);
            });
          }
          
        } catch(err) {
          console.error("Fout bij toevoegen leerling:", err);
          alert("Er ging iets mis bij het toevoegen van de leerling.");
        }
      };
    }
  }, 100);
});

// --- LEVELS object ---
const LEVELS = {
  "1-1": function() {
    const lc = document.getElementById('levelContainer');
    document.getElementById('mapContainer').style.display = 'none';
    document.getElementById('xpDisplay').style.display = 'none';
    lc.innerHTML = `<iframe src="lvl101.html" style="width:100%;height:100%;border:none;"></iframe>`;
    lc.style.display='block';
    window.completeLevelFromIframe = function(verdiendeXP, geslaagd){ completeLevel("1-1", verdiendeXP, geslaagd); };
  },
  "1-2": function() {
    const lc = document.getElementById('levelContainer');
    document.getElementById('mapContainer').style.display = 'none';
    document.getElementById('xpDisplay').style.display = 'none';
    lc.innerHTML = `<iframe src="lvl102.html" style="width:100%;height:100%;border:none;"></iframe>`;
    lc.style.display='block';
    window.completeLevelFromIframe = function(verdiendeXP, geslaagd){ completeLevel("1-2", verdiendeXP, geslaagd); };
  },
  "1-3": function() {
    const lc = document.getElementById('levelContainer');
    document.getElementById('mapContainer').style.display = 'none';
    document.getElementById('xpDisplay').style.display = 'none';
    lc.innerHTML = `<iframe src="lvl103.html" style="width:100%;height:100%;border:none;"></iframe>`;
    lc.style.display='block';
    window.completeLevelFromIframe = function(verdiendeXP, geslaagd){ completeLevel("1-3", verdiendeXP, geslaagd); };
  },
  "1-4": function() {
    const lc = document.getElementById('levelContainer');
    document.getElementById('mapContainer').style.display = 'none';
    document.getElementById('xpDisplay').style.display = 'none';
    lc.innerHTML = `<iframe src="lvl104.html" style="width:100%;height:100%;border:none;"></iframe>`;
    lc.style.display='block';
    window.completeLevelFromIframe = function(verdiendeXP, geslaagd){ completeLevel("1-4", verdiendeXP, geslaagd); };
  },
  "1-5": function() {
    const lc = document.getElementById('levelContainer');
    document.getElementById('mapContainer').style.display = 'none';
    document.getElementById('xpDisplay').style.display = 'none';
    lc.innerHTML = `<iframe src="lvl105.html" style="width:100%;height:100%;border:none;"></iframe>`;
    lc.style.display='block';
    window.completeLevelFromIframe = function(verdiendeXP, geslaagd){ completeLevel("1-5", verdiendeXP, geslaagd); };
  },
  "1-6": function() {
    const lc = document.getElementById('levelContainer');
    document.getElementById('mapContainer').style.display = 'none';
    document.getElementById('xpDisplay').style.display = 'none';
    lc.innerHTML = `<iframe src="lvl106.html" style="width:100%;height:100%;border:none;"></iframe>`;
    lc.style.display='block';
    window.completeLevelFromIframe = function(verdiendeXP, geslaagd){ completeLevel("1-6", verdiendeXP, geslaagd); };
  },
  "1-7": function() {
    const lc = document.getElementById('levelContainer');
    document.getElementById('mapContainer').style.display = 'none';
    document.getElementById('xpDisplay').style.display = 'none';
    lc.innerHTML = `<iframe src="lvl107.html" style="width:100%;height:100%;border:none;"></iframe>`;
    lc.style.display='block';
    window.completeLevelFromIframe = function(verdiendeXP, geslaagd){ completeLevel("1-7", verdiendeXP, geslaagd); };
  },
  "1-8": function() {
    const lc = document.getElementById('levelContainer');
    document.getElementById('mapContainer').style.display = 'none';
    document.getElementById('xpDisplay').style.display = 'none';
    lc.innerHTML = `<iframe src="lvl108.html" style="width:100%;height:100%;border:none;"></iframe>`;
    lc.style.display='block';
    window.completeLevelFromIframe = function(verdiendeXP, geslaagd){ completeLevel("1-8", verdiendeXP, geslaagd); };
  },
  "1-9": function() {
    const lc = document.getElementById('levelContainer');
    document.getElementById('mapContainer').style.display = 'none';
    document.getElementById('xpDisplay').style.display = 'none';
    lc.innerHTML = `<iframe src="lvl107.html" style="width:100%;height:100%;border:none;"></iframe>`;
    lc.style.display='block';
    window.completeLevelFromIframe = function(verdiendeXP, geslaagd){ completeLevel("1-9", verdiendeXP, geslaagd); };
  }
};

function openLevel(levelId, lesName){
  if(LEVELS[levelId]) LEVELS[levelId]();
  else {
    const lc = document.getElementById('levelContainer');
    document.getElementById('mapContainer').style.display = 'none';
    document.getElementById('xpDisplay').style.display = 'none';

    lc.innerHTML = `
      <h2>${lesName} - Level ${levelId}</h2>
      <p style="font-size:18px; margin-top:20px;">
        üöß Deze level is nog niet beschikbaar.
      </p>
      <button class="backBtn" style="margin-top:30px;">Keer terug</button>
    `;
    lc.style.display = 'block';

    lc.querySelector('.backBtn').onclick = () => {
      lc.style.display = 'none';
      document.getElementById('mapContainer').style.display = 'block';
      document.getElementById('xpDisplay').style.display = 'block';
    };
  }
}

window.completeLevel = async function(levelId, verdiendeXP, geslaagd){
  const [lesNumStr,lvlNumStr] = levelId.split('-');
  const lesNum = parseInt(lesNumStr,10);
  const lvlNum = parseInt(lvlNumStr,10);
  const lesson = LESSONS[lesNum-1];

  // Verhoog attempts
  state[levelId] = state[levelId] || { attempts: 0 };
  state[levelId].attempts = (state[levelId].attempts || 0) + 1;

  if(geslaagd) state.xp += verdiendeXP;

  lesson.levels.forEach((lvl, idx)=>{
    state[lvl.id] = state[lvl.id] || { attempts: 0 }; 
    if(idx < lvlNum-1) state[lvl.id].completed = true;
    else if(idx === lvlNum-1){
      if(geslaagd) {
        state[lvl.id].completed = true;
        state[lvl.id].failed = false;
      } else {
        state[lvl.id].failed = true;
      }
    }
  });

  Object.keys(state).forEach(k=>{
    if(k !== 'xp' && state[k] && typeof state[k] === 'object') state[k].current = false;
  });

  let nextSet = false;

  if(lvlNum < lesson.levels.length && geslaagd){
    const next = lesson.levels[lvlNum];
    state[next.id] = state[next.id] || { attempts: 0 };
    state[next.id].current = true;
    nextSet = true;
  }

  if(lvlNum === lesson.levels.length && geslaagd && lesNum < LESSONS.length){
    const nextLesson = LESSONS[lesNum];
    const firstNext = nextLesson.levels[0];
    state[firstNext.id] = state[firstNext.id] || { attempts: 0 };
    state[firstNext.id].current = true;
    nextSet = true;
  }

  if(!nextSet){
    state[levelId].current = true;
  }

  saveState();
  await saveToFirebase();
  
  document.getElementById('levelContainer').style.display='none';
  document.getElementById('mapContainer').style.display='block';
  document.getElementById('xpDisplay').style.display='block';
  
  drawMap();

  const messageBox = document.getElementById('messageBox');
  if(!geslaagd){
    messageBox.innerText = `‚ö†Ô∏è Je hebt level ${levelId} niet gehaald. Probeer het opnieuw.`;
    messageBox.style.display='block';
    setTimeout(()=>{ messageBox.style.display='none'; },5000);
  } else if(lvlNum === lesson.levels.length && geslaagd){
    messageBox.innerText = (lesNum < LESSONS.length)
      ? `üéâ Proficiat! Je hebt les ${lesNum} met succes afgerond! De volgende les is nu beschikbaar.`
      : `üèÜ Fantastisch! Je hebt de volledige lessenreeks gemaakt.`;
    messageBox.style.display='block';
    setTimeout(()=>{ messageBox.style.display='none'; },5000);
  }
};

const container = document.getElementById('mapContainer');
function drawMap(){
  container.innerHTML='';

  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS,"svg");
  svg.setAttribute("id","mapPath");
  svg.setAttribute("width","100%");
  svg.setAttribute("viewBox",`0 0 ${container.offsetWidth} 1`);
  container.appendChild(svg);

  let yOffset=30;
  const XS=200,R=25,stepY=4*R;

  let clickableLevelId = null;

  outerLoop:
  for(let lesson of LESSONS){
    for(let lvl of lesson.levels){
      if(state[lvl.id]?.failed){
        clickableLevelId = lvl.id;
        state[clickableLevelId].current = true;
        break outerLoop;
      }
    }
  }

  if(!clickableLevelId){
    outerLoop:
    for(let lesson of LESSONS){
      for(let lvl of lesson.levels){
        if(state[lvl.id]?.current){
          clickableLevelId = lvl.id;
          break outerLoop;
        }
      }
    }
  }

  if(!clickableLevelId){
    outerLoop:
    for(let lesson of LESSONS){
      for(let lvl of lesson.levels){
        if(!state[lvl.id]?.completed && !state[lvl.id]?.failed){
          clickableLevelId = lvl.id;
          state[clickableLevelId] = state[clickableLevelId] || { attempts: 0 };
          state[clickableLevelId].current = true;
          break outerLoop;
        }
      }
    }
  }

  let failedLevelEl = null;
  let currentLevelEl = null;
  let maxYPosition = 0;

  LESSONS.forEach((lesson,lIdx)=>{
    if(lIdx>0){
      const divider=document.createElement('div');
      divider.className='lesson-divider';
      divider.style.top=(yOffset-20)+'px';
      container.appendChild(divider);
    }

    const title=document.createElement('div');
    title.className='lesson-title';
    title.innerText=LESSON_NAMES[lIdx];
    title.style.top=(lIdx===0?yOffset:yOffset+10)+'px';
    container.appendChild(title);

    const YS=yOffset+30;
    const startLabel=document.createElement('div');
    startLabel.className='route-label';
    startLabel.style.top=YS+'px';
    startLabel.innerText='START';
    container.appendChild(startLabel);

    let lastLevelY=0, prevX=XS, prevY=YS+45/2;

    lesson.levels.forEach((lvl,idx)=>{
      const div=document.createElement('div');
      div.className='level';
      const Xpos=(idx===0)?XS+4*R:((idx%2===1)?XS-4*R:XS+4*R);
      const Ypos=YS+(idx+1)*stepY+40;
      lastLevelY=Ypos;
      div.style.left=(Xpos-R)+'px';
      div.style.top=(Ypos-R)+'px';
      
      const s=state[lvl.id]||{ attempts: 0 };
      const attempts = s.attempts || 0;
      
      // Check if this level is before current and has no attempts
      const isBeforeCurrent = clickableLevelId && isLevelBefore(lvl.id, clickableLevelId);
      
      if(s.current){
        div.classList.add('current');
        currentLevelEl = div;
      } else if(isBeforeCurrent && attempts === 0) {
        div.classList.add('skipped');
      } else if(s.completed) {
        if(attempts === 1) {
          div.classList.add('completed-first');
        } else {
          div.classList.add('completed-retry');
        }
      } else if(s.failed){
        div.classList.add('failed');
        failedLevelEl = div;
      } else {
        div.classList.add('locked');
      }
      
      if(attempts > 0 && !div.classList.contains('locked') && !div.classList.contains('skipped')) {
        div.innerText = attempts;
      }

      if(clickableLevelId && lvl.id===clickableLevelId){
        div.onclick=()=>{ openLevel(lvl.id,LESSON_NAMES[lIdx]); };
      }

      container.appendChild(div);

      const path=document.createElementNS(svgNS,"path");
      const startX=prevX,startY=prevY,endX=Xpos,endY=Ypos-R;
      const midX=(startX+endX)/2,midY=startY+(endY-startY)/2;
      path.setAttribute("d",`M ${startX} ${startY} Q ${startX} ${midY} ${midX} ${midY} T ${endX} ${endY}`);
      path.setAttribute("stroke","#555");
      path.setAttribute("stroke-width","4");
      path.setAttribute("fill","none");
      svg.appendChild(path);

      prevX=Xpos;
      prevY=Ypos+R;
    });

    const finishX=XS, finishY=lastLevelY+stepY+45/2;
    const pathToFinish=document.createElementNS(svgNS,"path");
    const midX2=(prevX+finishX)/2, midY2=prevY+(finishY-prevY)/2;
    pathToFinish.setAttribute("d",`M ${prevX} ${prevY} Q ${prevX} ${midY2} ${midX2} ${midY2} T ${finishX} ${finishY}`);
    pathToFinish.setAttribute("stroke","#555");
    pathToFinish.setAttribute("stroke-width","4");
    pathToFinish.setAttribute("fill","none");
    svg.appendChild(pathToFinish);

    const finishLabel=document.createElement('div');
    finishLabel.className='route-label';
    finishLabel.innerText="FINISH";
    finishLabel.style.top=(lastLevelY+stepY)+'px';
    container.appendChild(finishLabel);

    yOffset=lastLevelY+stepY+80;
    maxYPosition = Math.max(maxYPosition, yOffset);
  });

  svg.setAttribute("height", maxYPosition);
  svg.setAttribute("viewBox", `0 0 ${container.offsetWidth} ${maxYPosition}`);

  updateXPDisplay();

  setTimeout(() => {
    let scrollEl = currentLevelEl || failedLevelEl;
    if(scrollEl){
      const rect = scrollEl.getBoundingClientRect();
      const scrollTop = window.scrollY + rect.top - window.innerHeight/2 + rect.height/2;
      window.scrollTo({ top: scrollTop, behavior: "smooth" });
    }
  }, 100);
}

document.getElementById('resetBtn').onclick = async ()=>{
  if(!leerlingIdGlobal){ 
    alert("Geen leerling ingelogd."); 
    return; 
  }

  const code = prompt("Geef resetcode in:");
  if(code==='852874179639'){
    const levelInput = prompt("Naar welke level wil je resetten? (bijv. 1.1, 2.2)");
    const [lesNrStr, lvlNrStr] = levelInput.split('.');
    const lesNr = parseInt(lesNrStr,10), lvlNr = parseInt(lvlNrStr,10);
    let valid = LESSONS[lesNr-1]?.levels[lvlNr-1] !== undefined;
    if(!valid){ alert("Deze level bestaat niet. Geef een ander level in."); return; }

    state.xp = 0;
    LESSONS.forEach((lesson,lIdx)=>{
      lesson.levels.forEach((lvl,idx)=>{
        if(lIdx+1 < lesNr || (lIdx+1 === lesNr && idx+1 < lvlNr)) {
          state[lvl.id] = {completed:true, attempts: 1};
        } else if(lIdx+1 === lesNr && idx+1 === lvlNr) {
          state[lvl.id] = {current:true, attempts: 0};
        } else {
          state[lvl.id] = { attempts: 0 };
        }
      });
    });
    saveState();
    drawMap();
    await saveToFirebase();
  } else alert("De code is fout. Er verandert niets.");
};

if(Object.keys(state).length===0){ state[LESSONS[0].levels[0].id] = { current:true, attempts: 0 }; }

</script>
</body>
</html>


