<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Wereldkaart Prototype Verticaal</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f4f8; display: flex; justify-content: center; }
#mapContainer { position: relative; width: 400px; min-height: 3000px; margin: 0 auto; }
.lesson-divider { position: absolute; height: 4px; background: #999; width: 100%; }
.level { position: absolute; width: 50px; height: 50px; border-radius: 50%; border: 3px solid #ccc; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
.level:hover { transform: scale(1.1); }
.level.completed::after { content: '‚≠ê'; position: absolute; font-size: 18px; }
.level.current { background: gold; border-color: #f4a300; }
.level.failed { background: #f8c8d0; border-color: #f08090; }
.level.locked::after { content: 'üîí'; font-size: 20px; }
.route-label { position: absolute; width: 120px; height: 45px; border-radius: 25px; background: #d8c7ff; display: flex; justify-content: center; align-items: center; font-weight: bold; left: 50%; transform: translateX(-50%); }
.lesson-title { position: absolute; width: 100%; text-align: center; font-weight: bold; font-size: 14px; left: 0; transform: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#resetBtn { position: fixed; top: 20px; right: 20px; padding: 10px 15px; background: #007BFF; color: white; border: none; border-radius: 10px; cursor: pointer; }
#xpDisplay { position: fixed; top: 20px; left: 20px; padding: 8px 12px; background: #ffd700; color: black; font-weight: bold; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1000; }
#mapPath { position: absolute; top: 0; left: 0; z-index: 0; }
#levelContainer { position: fixed; top:0; left:0; width:100vw; height:100vh; background:white; z-index:2000; display:none; padding:30px; overflow:auto; }
#messageBox { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #d4edda; color: #155724; padding: 15px 25px; border-radius: 12px; font-weight: bold; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: none; z-index: 1500; }
input { margin:5px; padding:5px; width:80px; }
button { padding:5px 10px; margin-top:10px; }
</style>
</head>
<body>

<div id="loginContainer" style="text-align:center; margin-bottom:20px;">
  <label>Naam: <input type="text" id="loginName"></label>
  <button id="loginBtn">Start</button>
</div>
<div id="xpDisplay">XP: 0</div>
<button id="resetBtn">Reset</button>
<div id="mapContainer"></div>
<div id="levelContainer"></div>
<div id="messageBox"></div>

<script type="module">

document.getElementById('mapContainer').style.display = 'none';
document.getElementById('xpDisplay').style.display = 'none';
document.getElementById('resetBtn').style.display = 'none';

const LESSONS = [
  {id:"les1", levels:[{id:"1-1"},{id:"1-2"},{id:"1-3"},{id:"1-4"},{id:"1-5"}]},
  {id:"les2", levels:[{id:"2-1"},{id:"2-2"},{id:"2-3"},{id:"2-4"}]},
  {id:"les3", levels:[{id:"3-1"},{id:"3-2"},{id:"3-3"},{id:"3-4"}]},
  {id:"les4", levels:[{id:"4-1"},{id:"4-2"},{id:"4-3"},{id:"4-4"},{id:"4-5"},{id:"4-6"},{id:"4-7"},{id:"4-8"}]},
  {id:"les5", levels:[{id:"5-1"},{id:"5-2"},{id:"5-3"},{id:"5-4"}]},
  {id:"les6", levels:[{id:"6-1"},{id:"6-2"},{id:"6-3"}]}
];

const LESSON_NAMES = [
  "1 | Een positief getal optellen en aftrekken",
  "2 | Een negatief getal optellen en aftrekken",
  "3 | Vermenigvuldigen en delen met negatieve getallen",
  "4 | Macht van een getal",
  "5 | Vierkantswortel van een getal",
  "6 | De volgorde van de bewerkingen"
];

let state = JSON.parse(localStorage.getItem('mapState')) || {};
state.xp = state.xp || 0;

// --- Firebase setup ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDIxC6htGU-SNrgYMiXSmIyBm1wHX-ObWk",
  authDomain: "remediering-map.firebaseapp.com",
  databaseURL: "https://remediering-map-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "remediering-map",
  storageBucket: "remediering-map.appspot.com",
  messagingSenderId: "1070819853672",
  appId: "1:1070819853672:web:b4cdefa00ae068826382dd"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

console.log("üî• Firebase verbonden");

// --- Functies ---
function createLeerlingId(naam){ return "leerling_" + naam.toLowerCase().replace(/\s/g,"_"); }
let leerlingIdGlobal; 

async function saveToFirebase() {
  if(!leerlingIdGlobal) return;
  
  const leerlingRef = ref(db, "leerlingen/" + leerlingIdGlobal);
  
  try {
    const snapshot = await get(leerlingRef);
    const bestaandeData = snapshot.exists() ? snapshot.val() : {};
    
    // Alleen levels, xp en laatstBijgewerkt updaten, de rest blijft behouden
    await set(leerlingRef, {
      ...bestaandeData,              // behoud naam, actief, etc.
      xp: state.xp,
      levels: Object.fromEntries(LESSONS.flatMap(l => l.levels.map(lvl => [lvl.id, state[lvl.id] || {}]))),
      laatstBijgewerkt: Date.now()
    });
    
    console.log("üíæ Resultaten opgeslagen in Firebase");
  } catch(err) {
    console.error("‚ùå Fout bij opslaan:", err);
  }
}

function saveState(){ localStorage.setItem('mapState', JSON.stringify(state)); }
function updateXPDisplay(){ document.getElementById('xpDisplay').innerText = `XP: ${state.xp}`; }

// --- Login knop ---
document.getElementById('loginBtn').onclick = async function() {
  const naam = document.getElementById('loginName').value.trim();
  if(!naam){ alert("Gelieve een naam in te vullen"); return; }

  const leerlingId = createLeerlingId(naam);
  leerlingIdGlobal = leerlingId;
  const leerlingRef = ref(db, "leerlingen/" + leerlingId);

  try {
    const snapshot = await get(leerlingRef);

    // --- Controleer of leerling bestaat ---
    if(!snapshot.exists()){
      alert("Je bent niet geregistreerd. Neem contact op met je leerkracht.");
      return;
    }

    const data = snapshot.val();
    // --- Automatisch levels aanmaken voor nieuwe leerling als ze nog niet bestaan ---
    if(!data.levels){
      data.levels = Object.fromEntries(
        LESSONS.flatMap(l => l.levels.map(lvl => [lvl.id, {}]))
      );
      
      await set(leerlingRef, {
        ...data,
        levels: data.levels,
        xp: 0,
        laatstBijgewerkt: Date.now()
      });
    }

    // --- Controleer of account actief is ---
    if(data.actief !== true){
      alert("Je account is niet actief.");
      return;
    }
    
    // --- Vanaf hier mag de leerling starten ---
   state = data.levels ? {...data.levels} : {};
   state.xp = data.xp || 0;
    
    // --- Verwijder oude current flags, maar sla 'xp' over ---
    Object.keys(state).forEach(k => { 
      if(k !== "xp" && state[k]) state[k].current = false; 
    });

    // Bepaal automatisch current level
    let firstFailed = null;
    outerLoop:
    for(let lesson of LESSONS){
      for(let lvl of lesson.levels){
        if(state[lvl.id]?.failed){
          firstFailed = lvl.id;
          break outerLoop;
        }
      }
    }
    if(firstFailed) state[firstFailed].current = true;
    else {
      outerLoop:
      for(let lesson of LESSONS){
        for(let lvl of lesson.levels){
          if(!state[lvl.id]?.completed){
            state[lvl.id] = state[lvl.id] || {};
            state[lvl.id].current = true;
            break outerLoop;
          }
        }
      }
    }

    console.log(`üîπ Voortgang geladen voor ${naam}`);


    document.getElementById('loginContainer').style.display='none';
    document.getElementById('mapContainer').style.display='block';
    document.getElementById('xpDisplay').style.display='block';
    document.getElementById('resetBtn').style.display='block';

    drawMap();
    saveToFirebase();
  } catch(err){
    console.error("‚ùå Fout bij ophalen van Firebase:", err);
    alert("Er is iets misgelopen bij het laden van je voortgang.");
  }
};

// --- LEVELS object ---
const LEVELS = {
  "1-1": function() {
    const lc = document.getElementById('levelContainer');
    document.getElementById('mapContainer').style.display = 'none';
    document.getElementById('xpDisplay').style.display = 'none';
    lc.innerHTML = `<iframe src="lvl101.html" style="width:100%;height:100%;border:none;"></iframe>`;
    lc.style.display='block';
    window.completeLevelFromIframe = function(verdiendeXP, geslaagd){ completeLevel("1-1", verdiendeXP, geslaagd); };
  },
  "1-2": function() {
    const lc = document.getElementById('levelContainer');
    document.getElementById('mapContainer').style.display = 'none';
    document.getElementById('xpDisplay').style.display = 'none';
    lc.innerHTML = `<iframe src="lvl102.html" style="width:100%;height:100%;border:none;"></iframe>`;
    lc.style.display='block';
    window.completeLevelFromIframe = function(verdiendeXP, geslaagd){ completeLevel("1-2", verdiendeXP, geslaagd); };
  }
  // Voeg hier nieuwe echte levels toe
};

// --- Level openen ---
function openLevel(levelId, lesName){
  if(LEVELS[levelId]) LEVELS[levelId]();
  else {
    const lc = document.getElementById('levelContainer');
    document.getElementById('mapContainer').style.display = 'none';
    document.getElementById('xpDisplay').style.display = 'none';

    lc.innerHTML = `
      <h2>${lesName} - Level ${levelId}</h2>
      <div><label>Verdiende XP: <input class="xpInput" type="number" value="10"></label></div>
      <div><label>Cesuur: <input class="cesuurInput" type="number" value="5"></label></div>
      <button class="finishBtn">Be√´indigen</button>
      <button class="backBtn">OK</button>
      <p>Gebruik dit template om je level-specifieke code of opdrachten in te vullen.</p>
    `;
    lc.style.display='block';

    lc.querySelector('.finishBtn').onclick = () => {
      const xp = Math.max(0, parseInt(lc.querySelector('.xpInput').value));
      const cesuur = parseInt(lc.querySelector('.cesuurInput').value);
      completeLevel(levelId, xp, xp >= cesuur);
    };
    lc.querySelector('.backBtn').onclick = () => {
      lc.style.display='none';
      document.getElementById('mapContainer').style.display='block';
      document.getElementById('xpDisplay').style.display='block';
    };
  }
}

// --- Level afronden ---
window.completeLevel = async function(levelId, verdiendeXP, geslaagd){
  const [lesNumStr,lvlNumStr] = levelId.split('-');
  const lesNum = parseInt(lesNumStr,10);
  const lvlNum = parseInt(lvlNumStr,10);
  const lesson = LESSONS[lesNum-1];

  if(geslaagd) state.xp += verdiendeXP;

  // --- Behoud bestaande data en markeer levels correct ---
  lesson.levels.forEach((lvl, idx)=>{
    state[lvl.id] = state[lvl.id] || {}; 
    if(idx < lvlNum-1) state[lvl.id].completed = true;
    else if(idx === lvlNum-1){
      if(geslaagd) state[lvl.id].completed = true;
      else state[lvl.id].failed = true;
    }
    // laat current voorlopig staan
  });

  // --- Verwijder alle huidige current flags ---
  Object.keys(state).forEach(k=>{
    if(k !== 'xp') state[k].current = false;
  });

  // --- Zet volgende level als current ---
  let nextSet = false;

  // 1Ô∏è‚É£ volgende level in dezelfde les
  if(lvlNum < lesson.levels.length && geslaagd){
    const next = lesson.levels[lvlNum];
    state[next.id] = state[next.id] || {};
    state[next.id].current = true;
    nextSet = true;
  }

  // 2Ô∏è‚É£ eerste level van volgende les
  if(lvlNum === lesson.levels.length && geslaagd && lesNum < LESSONS.length){
    const nextLesson = LESSONS[lesNum];
    const firstNext = nextLesson.levels[0];
    state[firstNext.id] = state[firstNext.id] || {};
    state[firstNext.id].current = true;
    nextSet = true;
  }

  // 3Ô∏è‚É£ als falen of laatste level, blijf current bij dit level
  if(!nextSet){
    state[levelId].current = true;
  }

  saveState();
  drawMap();
  await saveToFirebase();

  document.getElementById('levelContainer').style.display='none';
  document.getElementById('mapContainer').style.display='block';
  document.getElementById('xpDisplay').style.display='block';

  const messageBox = document.getElementById('messageBox');
  if(!geslaagd){
    messageBox.innerText = `‚ö†Ô∏è Je bent gefaald bij level ${levelId}. Probeer het opnieuw.`;
    messageBox.style.display='block';
    setTimeout(()=>{ messageBox.style.display='none'; },5000);
  } else if(lvlNum === lesson.levels.length && geslaagd){
    messageBox.innerText = (lesNum < LESSONS.length)
      ? `üéâ Proficiat! Je hebt les ${lesNum} met succes afgerond! De volgende les is nu beschikbaar.`
      : `üèÜ Fantastisch! Je hebt de volledige lessenreeks gemaakt.`;
    messageBox.style.display='block';
    setTimeout(()=>{ messageBox.style.display='none'; },5000);
  }
};

// --- Map tekenen ---
const container = document.getElementById('mapContainer');
function drawMap(){
  container.innerHTML='';

  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS,"svg");
  svg.setAttribute("id","mapPath");
  svg.setAttribute("width","100%");
  svg.setAttribute("height","1");
  svg.setAttribute("viewBox",`0 0 ${container.offsetWidth} 1`);
  container.appendChild(svg);

  let yOffset=30;
  const XS=200,R=25,stepY=4*R;

  // --- Bepaal clickableLevelId (huidige level) ---
  let clickableLevelId = null;

  // 1Ô∏è‚É£ Failed levels krijgen prioriteit
  outerLoop:
  for(let lesson of LESSONS){
    for(let lvl of lesson.levels){
      if(state[lvl.id]?.failed){
        clickableLevelId = lvl.id;
        state[clickableLevelId].current = true;
        break outerLoop;
      }
    }
  }

  // 2Ô∏è‚É£ Huidige level
  if(!clickableLevelId){
    outerLoop:
    for(let lesson of LESSONS){
      for(let lvl of lesson.levels){
        if(state[lvl.id]?.current){
          clickableLevelId = lvl.id;
          break outerLoop;
        }
      }
    }
  }

  // 3Ô∏è‚É£ Eerste incomplete level
  if(!clickableLevelId){
    outerLoop:
    for(let lesson of LESSONS){
      for(let lvl of lesson.levels){
        if(!state[lvl.id]?.completed && !state[lvl.id]?.failed){
          clickableLevelId = lvl.id;
          state[clickableLevelId].current = true;
          break outerLoop;
        }
      }
    }
  }

  let failedLevelEl = null;

  LESSONS.forEach((lesson,lIdx)=>{
    if(lIdx>0){
      const divider=document.createElement('div');
      divider.className='lesson-divider';
      divider.style.top=(yOffset-20)+'px';
      container.appendChild(divider);
    }

    const title=document.createElement('div');
    title.className='lesson-title';
    title.innerText=LESSON_NAMES[lIdx];
    title.style.top=(lIdx===0?yOffset:yOffset+10)+'px';
    container.appendChild(title);

    const YS=yOffset+30;
    const startLabel=document.createElement('div');
    startLabel.className='route-label';
    startLabel.style.top=YS+'px';
    startLabel.innerText='START';
    container.appendChild(startLabel);

    let lastLevelY=0, prevX=XS, prevY=YS+45/2;

    lesson.levels.forEach((lvl,idx)=>{
      const div=document.createElement('div');
      div.className='level';
      const Xpos=(idx===0)?XS+4*R:((idx%2===1)?XS-4*R:XS+4*R);
      const Ypos=YS+(idx+1)*stepY+40;
      lastLevelY=Ypos;
      div.style.left=(Xpos-R)+'px';
      div.style.top=(Ypos-R)+'px';
      const s=state[lvl.id]||{};
      if(s.completed) div.classList.add('completed');
      else if(s.failed){
        div.classList.add('failed');
        failedLevelEl = div;
      }
      else if(s.current) div.classList.add('current');
      else div.classList.add('locked');

      if(clickableLevelId && lvl.id===clickableLevelId){
        div.onclick=()=>{ openLevel(lvl.id,LESSON_NAMES[lIdx]); };
      }

      container.appendChild(div);

      const path=document.createElementNS(svgNS,"path");
      const startX=prevX,startY=prevY,endX=Xpos,endY=Ypos-R;
      const midX=(startX+endX)/2,midY=startY+(endY-startY)/2;
      path.setAttribute("d",`M ${startX} ${startY} Q ${startX} ${midY} ${midX} ${midY} T ${endX} ${endY}`);
      path.setAttribute("stroke","#555");
      path.setAttribute("stroke-width","4");
      path.setAttribute("fill","none");
      svg.appendChild(path);

      prevX=Xpos;
      prevY=Ypos+R;
    });

    const finishX=XS, finishY=lastLevelY+stepY+45/2;
    const pathToFinish=document.createElementNS(svgNS,"path");
    const midX2=(prevX+finishX)/2, midY2=prevY+(finishY-prevY)/2;
    pathToFinish.setAttribute("d",`M ${prevX} ${prevY} Q ${prevX} ${midY2} ${midX2} ${midY2} T ${finishX} ${finishY}`);
    pathToFinish.setAttribute("stroke","#555");
    pathToFinish.setAttribute("stroke-width","4");
    pathToFinish.setAttribute("fill","none");
    svg.appendChild(pathToFinish);

    const finishLabel=document.createElement('div');
    finishLabel.className='route-label';
    finishLabel.innerText="FINISH";
    finishLabel.style.top=(lastLevelY+stepY)+'px';
    container.appendChild(finishLabel);

    yOffset=lastLevelY+stepY+80;
  });

  // --- Scroll automatisch naar huidige level ---
  requestAnimationFrame(()=>{
    const totalHeight = container.scrollHeight;
    svg.setAttribute("height", totalHeight);
    svg.setAttribute("viewBox", `0 0 ${container.offsetWidth} ${totalHeight}`);

    let scrollEl = container.querySelector(`.level.current`) || failedLevelEl;
    if(scrollEl){
      const rect = scrollEl.getBoundingClientRect();
      const scrollTop = window.scrollY + rect.top - window.innerHeight/2 + rect.height/2;
      window.scrollTo({ top: scrollTop, behavior: "smooth" });
    }
  });

  updateXPDisplay();
}

// --- Reset knop ---
document.getElementById('resetBtn').onclick = async ()=>{
  if(!leerlingIdGlobal){ 
    alert("Geen leerling ingelogd."); 
    return; 
  }

  const code = prompt("Geef resetcode in:");
  if(code==='852874179639'){
    const levelInput = prompt("Naar welke level wil je resetten? (bijv. 1.1, 2.2)");
    const [lesNrStr, lvlNrStr] = levelInput.split('.');
    const lesNr = parseInt(lesNrStr,10), lvlNr = parseInt(lvlNrStr,10);
    let valid = LESSONS[lesNr-1]?.levels[lvlNr-1] !== undefined;
    if(!valid){ alert("Deze level bestaat niet. Geef een ander level in."); return; }

    state.xp = 0;
    LESSONS.forEach((lesson,lIdx)=>{
      lesson.levels.forEach((lvl,idx)=>{
        if(lIdx+1 < lesNr || (lIdx+1 === lesNr && idx+1 < lvlNr)) state[lvl.id] = {completed:true};
        else if(lIdx+1 === lesNr && idx+1 === lvlNr) state[lvl.id] = {current:true};
        else state[lvl.id] = {};
      });
    });
    saveState();
    drawMap();
    await saveToFirebase();   // <--- async
  } else alert("De code is fout. Er verandert niets.");
};

if(Object.keys(state).length===0){ LESSONS[0].levels[0].current=true; }
drawMap();

</script>
</body>
</html>












